<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Togetherness TKJ OnE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== COLOR & TYPOGRAPHY VARIABLES ===== */
        :root {
            --sidebar-width: 250px;
            --sidebar-collapsed-width: 80px;
            --bg-primary: #000000;
            --bg-secondary: #111111;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-primary: #ff0000;
            --accent-gradient: linear-gradient(135deg, #ff0000 0%, #a300cc 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --border-radius: 16px;
            --transition-smooth: all 0.4s ease;
            --sidebar-bg: linear-gradient(180deg, rgba(17, 17, 17, 0.7) 0%, rgba(20, 20, 20, 0.5) 100%);
            --sidebar-border: rgba(255, 255, 255, 0.05);
        }
        :root.light-theme {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --accent-primary: #e74c3c;
            --accent-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            --glass-bg: rgba(0, 0, 0, 0.03);
            --glass-border: rgba(0, 0, 0, 0.1);
            --sidebar-bg: linear-gradient(180deg, rgba(255, 255, 255, 0.8) 0%, rgba(245, 245, 245, 0.6) 100%);
            --sidebar-border: rgba(0, 0, 0, 0.05);
        }

        /* ===== BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            --current-padding: var(--sidebar-width);
            padding-left: var(--current-padding);
            transition: padding-left 0.28s ease, --current-padding 0.28s ease;
        }
        body.sidebar-collapsed {
            --current-padding: var(--sidebar-collapsed-width);
        }

        /* ===== KEYFRAME ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes popIn {
            from { transform: translateY(10px) scale(.98); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes fadeInImg {
            from { opacity: 0; transform: scale(.995); }
            to { opacity: 1; transform: scale(1); }
        }

        /* ===== SIDEBAR STYLES ===== */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            padding: 1.5rem 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: inset 1px 0 1px rgba(255, 255, 255, 0.1), 2px 0 20px rgba(0, 0, 0, 0.3);
        }
        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
            align-items: center;
        }
        /* collapse effects: hide labels and show icons-only */
        .sidebar.collapsed .sidebar-title,
        .sidebar.collapsed .sidebar-subtitle,
        .sidebar.collapsed .sidebar-nav-link .label {
            display: none;
        }
        .sidebar.collapsed .sidebar-logos img {
            width: 46px;
            height: 46px;
        }
        .sidebar .sidebar-nav-link { padding-left: 1rem; }
        .sidebar.collapsed .sidebar-nav-link { justify-content: center; padding: 0.9rem 0; }

        /* tooltip when collapsed */
        .sidebar.collapsed .sidebar-nav-link::after {
            content: attr(data-tooltip);
            position: absolute;
            left: calc(var(--sidebar-collapsed-width) + 12px);
            white-space: nowrap;
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 0.9rem;
            transform: translateY(-50%);
            top: 50%;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.18s ease, left 0.18s ease;
            box-shadow: 0 6px 18px rgba(0,0,0,0.5);
            z-index: 1200;
        }
        .sidebar.collapsed .sidebar-nav-link:hover::after { opacity: 1; left: calc(var(--sidebar-collapsed-width) + 18px); }
        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 700;
            text-align: left;
            margin-bottom: 0.25rem;
            color: var(--accent-primary);
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .sidebar-subtitle {
            display: block;
            font-size: 0.95rem;
            font-weight: 400;
            text-align: left;
            margin: 0 0 1rem 0;
            color: var(--text-secondary);
            line-height: 1.35;
            opacity: 0.95;
        }
        .sidebar-nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem 1.2rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }
        .sidebar-submenu .sidebar-nav-link {
            padding-left: 2.2rem;
            font-size: 0.95rem;
            background: transparent;
            color: var(--text-secondary);
        }
        .sidebar-nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--accent-gradient);
            transition: left 0.4s ease;
            z-index: -1;
        }
        .sidebar-nav-link:hover {
            color: var(--text-primary);
            transform: translateX(5px);
        }
        .sidebar-nav-link:hover::before {
            left: 0;
        }
        .sidebar-nav-link.active {
            background: var(--accent-gradient);
            color: var(--bg-primary);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
        }
        .sidebar-nav-link i {
            width: 24px;
            text-align: center;
        }

        /* ===== SIDEBAR TOGGLE (Mobile Menu) ===== */
        .sidebar-toggle {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 1001;
            background: var(--accent-gradient);
            color: var(--bg-primary);
            border: none;
            padding: 0.9rem 1rem;
            border-radius: var(--border-radius);
            font-size: 1.3rem;
            cursor: pointer;
            transition: var(--transition-smooth);
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
            width: 50px;
            height: 50px;
            display: none;
            align-items: center;
            justify-content: center;
            min-width: 50px;
            min-height: 50px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .sidebar-toggle::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            cursor: pointer;
            z-index: -1;
        }
        .sidebar-toggle:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(255, 0, 0, 0.4);
        }
        .sidebar-toggle:hover {
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.4);
            transform: translateY(-2px);
        }
        .sidebar-toggle i {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }
        .sidebar.active ~ .sidebar-toggle i {
            transform: rotate(90deg);
        }

        /* ===== MAIN CONTENT AREA ===== */
        .main-content {
            padding: 2rem;
            animation: fadeIn 0.6s ease-out;
            transition: transform 0.28s ease, padding-left 0.28s ease, margin-right 0.28s ease;
            transform-origin: top left;
        }
        body.sidebar-collapsed .main-content {
            padding-left: 3rem;
            margin-right: 3rem;
        }
        .search-box {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 2rem;
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-primary);
        }

        /* ===== GALLERY SECTION ===== */
        .letter-section {
            margin-bottom: 2.5rem;
        }
        .letter-header {
            font-size: 1.8rem;
            margin: 1.5rem 0 1rem;
            color: var(--accent-primary);
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.2rem;
        }
        .gallery-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
        }
        .gallery-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
            background: #222;
        }
        .gallery-item-name {
            padding: 0.7rem;
            font-size: 0.95rem;
            text-align: center;
        }
        .gallery-item-date {
            padding: 0 0.7rem 0.7rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* ===== MODAL DIALOG STYLES ===== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
            z-index: 2200;
        }
        .modal.show {
            display: flex;
        }
        .modal-dialog {
            max-width: 920px;
            width: 92%;
            background: var(--bg-secondary);
            padding: 14px;
            border-radius: 14px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: popIn .28s cubic-bezier(.2, .9, .3, 1);
        }
        .modal-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 10px;
            object-fit: contain;
            opacity: 0;
            animation: fadeInImg .34s forwards .06s;
        }
        .modal-info {
            width: 100%;
            padding: 10px 6px;
        }
        .modal-name {
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
        }
        .modal-date {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-top: 0.4rem;
        }
        .modal-actions {
            margin-top: 0.6rem;
            text-align: center;
        }
        .close-btn {
            position: absolute;
            right: 18px;
            top: 12px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1.8rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .close-btn:hover {
            transform: scale(1.2);
        }
        .download-btn {
            padding: 0.5rem 0.9rem;
            border-radius: 10px;
            border: none;
            background: var(--accent-primary);
            color: #fff;
            cursor: pointer;
            transition: var(--transition-smooth);
            transform: translateY(0);
            position: relative;
            overflow: hidden;
        }
        .download-btn:hover {
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
            transform: translateY(-2px);
        }
        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* animate download button when modal opens */
        .modal.show .download-btn {
            animation: btnPop .28s cubic-bezier(.2,.9,.3,1) both;
        }

        @keyframes btnPop {
            0% { transform: translateY(8px) scale(.98); opacity: 0; }
            60% { transform: translateY(-4px) scale(1.03); opacity: 1; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }

        /* disable button animation in performance mode */
        .performance-mode .download-btn {
            animation: none !important;
            transition: none !important;
        }

        /* spinner shown when button has .loading */
        .download-btn.loading::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.25);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* ripple effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.22);
            transform: scale(0);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
        }
        @keyframes ripple { from { opacity: 0.9; transform: scale(0); } to { opacity: 0; transform: scale(2.5); } }

        /* disable spinner & ripple in performance-mode */
        .performance-mode .download-btn.loading::after,
        .performance-mode .download-btn .ripple {
            display: none !important;
            animation: none !important;
        }

        /* ===== DEVELOPER SECTION ===== */
        .developer-content {
            padding: 2rem;
            transition: transform 0.28s ease, padding-left 0.28s ease, margin-right 0.28s ease;
            transform-origin: top left;
        }
        body.sidebar-collapsed .developer-content {
            padding-left: 3rem;
            margin-right: 3rem;
        }
        .sidebar-profile {
            max-width: 500px;
            margin: 0 auto;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 0, 0, 0.05));
            border-radius: 12px;
            text-align: center;
        }
        .sidebar-profile img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-primary);
        }
        .sidebar-profile > div:nth-of-type(1) {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 0.8rem;
        }
        .sidebar-logos img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-primary);
        }
        .sidebar-profile p {
            color: var(--text-secondary);
            margin-top: 0.8rem;
            line-height: 1.6;
        }
        .sidebar-profile a {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.7rem 1.2rem;
            background: #25D366;
            color: #fff;
            border-radius: 999px;
            margin-top: 0.8rem;
            text-decoration: none;
            transition: var(--transition-smooth);
        }
        .sidebar-profile a:hover {
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
            transform: translateY(-2px);
        }
        /* collapse button */
        .sidebar-collapse {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            color: var(--text-primary);
            padding: 8px 10px;
            border-radius: 999px;
            cursor: pointer;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            transition: transform 0.18s ease, background 0.18s ease;
            z-index: 1100;
        }
        .sidebar-collapse:hover { transform: translateX(-50%) scale(1.03); }
        .sidebar.collapsed .sidebar-collapse i { transform: rotate(180deg); }

        /* ===== STATS & MESSAGES ===== */
        .stats-footer {
            display: none;
            margin-top: 2rem;
            padding: 1.2rem;
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.03), rgba(163, 0, 204, 0.03));
            border-top: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 12px;
            text-align: center;
        }

        /* ===== PERFORMANCE MODE (Low-End Device) ===== */
        .performance-mode .modal-dialog {
            animation: none !important;
        }
        .performance-mode .modal-image {
            animation: none !important;
            transition: none !important;
            opacity: 1 !important;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            body {
                padding-left: 0;
                padding-top: 50px;
            }
            .sidebar-toggle {
                display: flex;
            }
            .sidebar {
                width: 100%;
                left: -100%;
                transition: left 0.3s ease;
            }
            .sidebar.active {
                left: 0;
            }
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            .gallery-item img {
                height: 140px;
            }
        }
    </style>
</head>

<body>
    <!-- SIDEBAR TOGGLE (Mobile Menu) -->
    <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>

    <!-- SIDEBAR NAVIGATION -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="Sidebar Navigation">
        <div class="sidebar-logos">
         <img src="https://i.ibb.co/WqYBq7g/Whats-App-Image-2025-11-16-at-12-05-04-211ead99.jpg" alt="Logo">
        </div>
        <div class="sidebar-title">Togetherness TKJ OnE</div>
        <div class="sidebar-subtitle">Kenangan yang terukir dalam kebersamaan</div>
        <nav>
            <a href="#" class="sidebar-nav-link" data-filter="all" data-tooltip="Semua Foto"><i class="fas fa-images"></i> <span class="label">SEMUA FOTO</span></a>
            <div class="sidebar-submenu"><a href="#" class="sidebar-nav-link active" data-filter="group" data-tooltip="Foto Bersama"><i class="fas fa-users"></i> <span class="label">FOTO BERSAMA</span></a></div>
            <a href="#" class="sidebar-nav-link" data-filter="male" data-tooltip="Foto Laki-laki"><i class="fas fa-mars"></i> <span class="label">FOTO LAKI-LAKI</span></a>
            <a href="#" class="sidebar-nav-link" data-filter="female" data-tooltip="Foto Perempuan"><i class="fas fa-venus"></i> <span class="label">FOTO PEREMPUAN</span></a>
            <a href="#" class="sidebar-nav-link" data-filter="video" data-tooltip="Video"><i class="fas fa-video"></i> <span class="label">VIDEO</span></a>
            <a href="#" class="sidebar-nav-link" data-target="about" data-tooltip="Developer"><i class="fas fa-user"></i> <span class="label">DEVELOPER</span></a>
        </nav>
        <div style="margin-top:auto;display:flex;flex-direction:column;gap:8px;align-items:center;">
            <button id="sidebarClearCache" style="width:90%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text-secondary);cursor:pointer;">Bersihkan cache</button>
        </div>
        <button id="sidebarCollapse" class="sidebar-collapse" aria-label="Toggle sidebar" aria-expanded="true" title="Toggle sidebar"> <i class="fas fa-chevron-left"></i> </button>
    </aside>

    <!-- MAIN GALLERY SECTION -->
    <main class="main-content" id="section-all">
        <div id="searchWrapper">
            <input type="text" id="searchInput" class="search-box" placeholder="Cari Berdasarkan Tanggal...">
        </div>
        <div id="noResultsMessage" style="text-align:center;margin:2rem 0;color:var(--text-secondary);display:none;">
            Maaf yo kawen,Tanggal: "<span id="searchedTerm"></span>" Indo lai tudo di database,cubo cek baliek
        </div>
        <div id="galleryContainer"></div>
        <div class="stats-footer" id="statsFooter"></div>
    </main>

    <!-- DEVELOPER PROFILE SECTION -->
    <main class="developer-content" id="section-about" style="display:none;">
        <div class="sidebar-profile">
            <img src="https://i.ibb.co/Fqy0Dgdj/4-Nov-14-35-lmc-8-4-1.jpg" alt="">
            <div>Zhyllan Fyllah</div>
            <p>Website ini saya buat sebagai memori atas keseharian kami di kelas TKJ 1 SMK N 1 LEMBAH MELINTANG. Di dalamnya
            tersimpan momen-momen yang mungkin terlihat sederhana, namun memiliki makna yang dalam bagi kami semua. Tawa, kerja
            sama, perjuangan, dan kebersamaan yang kami lalui selama satu tahun menjadi fondasi utama dari lahirnya 'Togetherness
            TKJ OnE'. Sebagai seorang siswa sekaligus pengembang, saya ingin menghadirkan ruang digital yang tidak hanya menyimpan
            foto, tetapi juga menyimpan rasa.<blockquote><br> website ini dapat menjadi pengingat bahwa di balik setiap gambar, ada cerita
            yang tak tergantikan.</blockquote></p> <p><br>Terima kasih kepada seluruh teman-teman yang telah menjadi bagian dari kisah ini. Semoga
            kebersamaan kita tetap hidup, meski waktu terus berjalan.</p>
            <a href="https://wa.me/6285165721384?text=Aku ondak mintak masuokken foto ko website album kito tu bulieh zhyllan ?" target="_blank">
                <i class="fab fa-whatsapp"></i> Kirim via WhatsApp
            </a>
        </div>
    </main>

    <!-- IMAGE MODAL POPUP -->
    <div class="modal" id="imageModal" onclick="closeModal()">
        <div class="modal-dialog" onclick="event.stopPropagation()">
            <button class="close-btn" aria-label="Tutup" onclick="closeModal()">&times;</button>
            <img id="modalImage" class="modal-image" src="" alt="Gambar">
            <div class="modal-info">
                <div id="modalName" class="modal-name"></div>
                <div id="modalDate" class="modal-date"></div>
                <div class="modal-actions">
                    <button id="downloadBtn" class="download-btn" onclick="downloadImage()">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== HELPER FUNCTIONS: DEVICE DETECTION & URL MANIPULATION =====
        function isLowEndDevice() {
            return (
                window.innerWidth <= 768 ||
                (navigator.deviceMemory && navigator.deviceMemory <= 2) ||
                (window.devicePixelRatio && window.devicePixelRatio <= 1.5) ||
                window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches
            );
        }

        function getThumbnailUrl(originalUrl) {
            try {
                const url = new URL(originalUrl);
                url.searchParams.set('w', '300');
                return url.toString();
            } catch (e) {
                return originalUrl;
            }
        }

        function getHDUrl(thumbUrl) {
            try {
                const url = new URL(thumbUrl);
                url.searchParams.delete('w');
                return url.toString();
            } catch (e) {
                return thumbUrl;
            }
        }

        // ===== CACHE MANAGEMENT =====
        const CACHE_KEY = 'photos_cache_v2';
        // Shorter default during active development so JSON edits appear quickly
        const CACHE_EXPIRY_HOURS = 1; // hours

        function loadFromCache() {
            const cached = localStorage.getItem(CACHE_KEY);
            if (!cached) return null;
            try {
                const { data, timestamp } = JSON.parse(cached);
                const now = Date.now();
                if (now - timestamp < CACHE_EXPIRY_HOURS * 60 * 60 * 1000) return data;
            } catch (e) {
                return null;
            }
            return null;
        }

        function saveToCache(data) {
            localStorage.setItem(CACHE_KEY, JSON.stringify({ data, timestamp: Date.now() }));
        }

        // ===== DATA LOADING: LOCAL & CACHE =====
        let photos = [];

        // loadFromLocal(options)
        // options.noStore -> fetch with cache: 'no-store'
        // options.bust -> append cache-busting query param
        async function loadFromLocal(options = {}) {
            try {
                const url = './DB/photos.json' + (options.bust ? ('?_=' + Date.now()) : '');
                const response = await fetch(url, { cache: options.noStore ? 'no-store' : 'default' });
                if (!response.ok) throw new Error('File tidak ditemukan');
                const data = await response.json();
                return data.photos;
            } catch (e) {
                console.warn('Fallback ke data dummy', e);
                return [{ name: "Zhyllan", gender: "male", url: "https://i.ibb.co/Fqy0Dgdj/4-Nov-14-35-lmc-8-4-1.jpg", date: "2025-11-04" }];
            }
        }

        // loadPhotosFromDB(forceFresh)
        // If forceFresh===true, bypass cache and fetch a fresh copy.
        async function loadPhotosFromDB(forceFresh = false) {
            const cached = !forceFresh ? loadFromCache() : null;
            if (cached) {
                photos = cached;
                console.log('[photos] loaded from cache, items:', (photos && photos.length) || 0);
                renderGallery();
                restoreUserState();

                // Background freshness check: fetch with no-store and update if changed
                try {
                    const fresh = await loadFromLocal({ noStore: true });
                    console.log('[photos] freshness check fetched items:', (fresh && fresh.length) || 0);
                    if (JSON.stringify(fresh) !== JSON.stringify(cached)) {
                        photos = fresh;
                        saveToCache(fresh);
                        console.log('[photos] cache updated from freshness check');
                        renderGallery();
                    }
                } catch (e) {
                    console.warn('Freshness check failed:', e);
                }
                return;
            }

            // No cache or forced refresh: fetch fresh
            try {
                const fresh = await loadFromLocal({ noStore: forceFresh, bust: forceFresh });
                console.log('[photos] fetched fresh items:', (fresh && fresh.length) || 0);
                photos = fresh;
                saveToCache(fresh);
                renderGallery();
                restoreUserState();
            } catch (err) {
                console.error('Gagal muat data baru:', err);
            }
        }

        // ===== DATE FORMATTING =====
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            return `${d}-${m}-${y}`;
        }

        // ===== GALLERY RENDERING & LAZY LOADING =====
        function renderGallery(filteredPhotos = photos) {
            const container = document.getElementById('galleryContainer');
            const noResultsMsg = document.getElementById('noResultsMessage');
            const currentQuery = document.getElementById('searchInput').value.trim();

            if (filteredPhotos.length === 0 && currentQuery) {
                document.getElementById('searchedTerm').textContent = currentQuery;
                noResultsMsg.style.display = 'block';
                container.innerHTML = '';
                document.getElementById('statsFooter').style.display = 'none';
                return;
            }

            noResultsMsg.style.display = 'none';
            container.innerHTML = '';
            const groups = {};
            filteredPhotos.forEach(photo => {
                const firstLetter = (photo.name || '?').charAt(0).toUpperCase();
                if (!groups[firstLetter]) groups[firstLetter] = [];
                groups[firstLetter].push(photo);
            });

            Object.keys(groups).sort().forEach(letter => {
                const section = document.createElement('div');
                section.className = 'letter-section';
                section.innerHTML = `<h2 class="letter-header">${letter}</h2><div class="gallery-grid" id="grid-${letter}"></div>`;
                container.appendChild(section);
                const grid = section.querySelector(`#grid-${letter}`);
                groups[letter].forEach(photo => {
                    const item = document.createElement('div');
                    item.className = 'gallery-item';
                    item.dataset.person = photo.name;
                    item.dataset.gender = photo.gender;
                    item.dataset.fullUrl = photo.url;
                    const thumbUrl = isLowEndDevice() ? getThumbnailUrl(photo.url) : photo.url;
                    const formattedDate = formatDate(photo.date);
                    item.innerHTML = `
                        <img data-src="${thumbUrl}" alt="${photo.name}" class="lazy">
                        <div class="gallery-item-name">${photo.name}</div>
                        <div class="gallery-item-date">${formattedDate}</div>
                    `;
                    item.onclick = () => openModal(photo.url, photo.name, photo.date);
                    grid.appendChild(item);
                });
            });
            initLazyLoading();
            updateStatistics(filteredPhotos);
        }

        function initLazyLoading() {
            if ('IntersectionObserver' in window) {
                const observerOptions = { root: null, rootMargin: '50px', threshold: 0.01 };
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.dataset.src;
                            const tempImg = new Image();
                            tempImg.onload = function() {
                                img.src = src;
                                img.classList.remove('lazy');
                                observer.unobserve(img);
                            };
                            tempImg.onerror = function() {
                                img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIj48cmVjdCBmaWxsPSIjMzMzIiB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIvPjwvc3ZnPg==';
                                img.classList.add('error');
                                observer.unobserve(img);
                            };
                            tempImg.src = src;
                        }
                    });
                }, observerOptions);
                document.querySelectorAll('img.lazy').forEach(img => {
                    img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIj48cmVjdCBmaWxsPSIjMjIyIiB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIvPjwvc3ZnPg==';
                    observer.observe(img);
                });
            } else {
                document.querySelectorAll('img.lazy').forEach(img => {
                    img.src = img.dataset.src;
                    img.classList.remove('lazy');
                });
            }
        }

        // ===== MODAL POPUP: OPEN, CLOSE, DOWNLOAD =====
        function openModal(fullUrl, name, date) {
            const hdUrl = getHDUrl(fullUrl);
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImage');
            document.getElementById('modalName').textContent = name || '';
            document.getElementById('modalDate').textContent = date ? formatDate(date) : '';
            // lock scroll
            document.body.style.overflow = 'hidden';
            // set src after small delay to allow animation
            img.src = '';
            modal.classList.add('show');
            // ensure the image loads and animates
            setTimeout(() => {
                img.src = hdUrl;
            }, 30);
            document.getElementById('downloadBtn').disabled = false;
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            // clear image after animation end to free memory
            const img = document.getElementById('modalImage');
            setTimeout(() => {
                try {
                    img.src = '';
                } catch (e) {}
            }, 300);
        }

        async function downloadImage() {
            const src = document.getElementById('modalImage').src;
            const name = (document.getElementById('modalName').textContent || 'photo').replace(/\s+/g, '_');
            const btn = document.getElementById('downloadBtn');
            if (btn) { btn.classList.add('loading'); btn.disabled = true; }
            try {
                const resp = await fetch(src);
                if (!resp.ok) throw new Error('Network');
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${name}.jpg`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch (err) {
                alert('Gagal mendownload gambar. Coba klik kanan > Simpan gambar.');
            } finally {
                if (btn) { btn.classList.remove('loading'); btn.disabled = false; }
            }
        }

        // Allow clearing the local cache (useful during debugging or updates)
        // If forceReload === true, fetch fresh JSON and re-render without full page reload.
        function clearCache(forceReload = true) {
            try {
                localStorage.removeItem(CACHE_KEY);
                console.log('[photos] cache cleared');
            } catch (e) { console.warn('Failed to clear cache', e); }
            if (forceReload) {
                const statsFooter = document.getElementById('statsFooter');
                if (statsFooter) {
                    statsFooter.style.display = 'block';
                    statsFooter.textContent = 'Memuat data baru...';
                }
                // reload photos bypassing cache
                loadPhotosFromDB(true);
            } else {
                location.reload();
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('imageModal');
                if (modal && modal.classList.contains('show')) closeModal();
            }
        });

        // ===== DOWNLOAD BUTTON INTERACTIONS (ripple + attach handler) =====
        function createRipple(e) {
            const btn = e.currentTarget;
            if (!btn) return;
            const rect = btn.getBoundingClientRect();
            const circle = document.createElement('span');
            circle.className = 'ripple';
            const size = Math.max(rect.width, rect.height);
            circle.style.width = circle.style.height = size + 'px';
            circle.style.left = (e.clientX - rect.left - size / 2) + 'px';
            circle.style.top = (e.clientY - rect.top - size / 2) + 'px';
            btn.appendChild(circle);
            setTimeout(() => { try { circle.remove(); } catch (e) {} }, 650);
        }

        const downloadBtn = document.getElementById('downloadBtn');
        if (downloadBtn) {
            downloadBtn.addEventListener('pointerdown', createRipple);
        }

        // ===== STATISTICS DISPLAY =====
        function updateStatistics(displayedPhotos) {
            const statsFooter = document.getElementById('statsFooter');
            if (!statsFooter) return;
            if (displayedPhotos.length === 0) {
                statsFooter.style.display = 'none';
                return;
            }
            statsFooter.style.display = 'block';
            const total = (photos && photos.length) ? photos.length : 0;
            statsFooter.innerHTML = `<span>${displayedPhotos.length} foto ditampilkan dari ${total} total.</span> <button id="clearCacheBtn" style="margin-left:12px;padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text-secondary);cursor:pointer;">Bersihkan cache</button>`;
            const btn = document.getElementById('clearCacheBtn');
            if (btn) btn.addEventListener('click', clearCache);
        }

        // ===== SIDEBAR NAVIGATION & FILTERING =====
        document.querySelectorAll('.sidebar-nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.sidebar-nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                const target = link.dataset.target;
                if (target) {
                    document.getElementById('section-all').style.display = 'none';
                    document.getElementById('section-about').style.display = 'block';
                    if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');
                    return;
                }
                const filter = link.dataset.filter;
                if (filter !== undefined) {
                    saveFilterState(filter);
                    document.getElementById('section-all').style.display = 'block';
                    document.getElementById('section-about').style.display = 'none';
                    const searchQuery = (document.getElementById('searchInput').value || '').toLowerCase().trim();
                    performSearch(searchQuery);
                    if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');
                }
            });
        });

        // ===== SEARCH & FILTER LOGIC =====
        function matchesDateQuery(photoDate, searchQuery) {
            if (!photoDate) return false;
            const formatted = formatDate(photoDate);
            const queryDigits = searchQuery.replace(/\D/g, '');
            const dateDigits = formatted.replace(/\D/g, '');
            return dateDigits.includes(queryDigits) || formatted.includes(searchQuery);
        }

        function performSearch(query) {
            const lastFilter = userPreferences.get('lastFilter') || 'group';
            let results = [...photos];
            if (query && query.trim().length > 0) {
                results = results.filter(p => {
                    const matchesName = (p.name || '').toLowerCase().includes(query);
                    const matchesDate = matchesDateQuery(p.date || '', query);
                    return matchesName || matchesDate;
                });
            }
            if (lastFilter && lastFilter !== 'all') {
                if (lastFilter === 'group') results = results.filter(p => p.gender === 'all');
                else if (lastFilter === 'male' || lastFilter === 'female') results = results.filter(p => p.gender === lastFilter);
            }
            renderGallery(results);
        }

        // Debounced search input
        let searchTimer;
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', function (e) {
            const query = this.value.toLowerCase().trim();
            clearTimeout(searchTimer);
            saveSearchState(query);
            searchTimer = setTimeout(() => {
                performSearch(query);
            }, 120);
        });

        // ===== USER PREFERENCES MANAGEMENT =====
        const userPreferences = {
            save: (k, v) => {
                const p = JSON.parse(localStorage.getItem('userPreferences') || '{}');
                p[k] = v;
                localStorage.setItem('userPreferences', JSON.stringify(p));
            },
            get: (k) => {
                const p = JSON.parse(localStorage.getItem('userPreferences') || '{}');
                return p[k];
            }
        };

        function saveFilterState(f) {
            userPreferences.save('lastFilter', f);
        }

        function saveSearchState(q) {
            userPreferences.save('lastSearch', q);
        }

        function restoreUserState() {
            const lastFilter = userPreferences.get('lastFilter') || 'group';
            const lastSearch = userPreferences.get('lastSearch') || '';
            if (lastSearch) document.getElementById('searchInput').value = lastSearch;
            const menuLink = document.querySelector(`[data-filter="${lastFilter}"]`);
            if (menuLink) menuLink.click();
            else {
                // fallback: click the first filter link (should exist)
                const first = document.querySelector('.sidebar-nav-link[data-filter]');
                if (first) first.click();
            }
        }

        // ===== THEME MANAGEMENT =====
        function loadTheme() {
            const saved = localStorage.getItem('theme') || 'dark';
            const html = document.documentElement;
            const toggle = document.getElementById('themeToggle');
            if (saved === 'light') {
                html.classList.add('light-theme');
                if (toggle) toggle.classList.add('active');
            } else {
                html.classList.remove('light-theme');
                if (toggle) toggle.classList.remove('active');
            }
        }

        // ===== MOBILE SIDEBAR TOGGLE =====
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('sidebarToggle');
        // safe-guard if toggle is missing
        if (toggleBtn) {
            toggleBtn.addEventListener('click', (e) => {
                // if sidebar is in collapsed (mini) mode on desktop, don't hide it via the top toggle
                if (sidebar.classList.contains('collapsed') && window.innerWidth > 768) return;
                sidebar.classList.toggle('active');
            });
        }

        // ===== SIDEBAR COLLAPSE (Desktop friendly) =====
        const collapseBtn = document.getElementById('sidebarCollapse');
        function applySidebarState(collapsed) {
            if (collapsed) {
                sidebar.classList.add('collapsed');
                document.body.classList.add('sidebar-collapsed');
                collapseBtn && collapseBtn.setAttribute('aria-expanded', 'false');
                // hide top hamburger toggle while in mini mode
                if (toggleBtn) toggleBtn.style.display = 'none';
            } else {
                sidebar.classList.remove('collapsed');
                document.body.classList.remove('sidebar-collapsed');
                collapseBtn && collapseBtn.setAttribute('aria-expanded', 'true');
                // restore top toggle visibility according to screen size
                if (toggleBtn) toggleBtn.style.display = (window.innerWidth <= 768) ? 'flex' : 'none';
            }
        }

        function toggleSidebarCollapsed() {
            const isCollapsed = sidebar.classList.contains('collapsed');
            const next = !isCollapsed;
            applySidebarState(next);
            try { localStorage.setItem('sidebarCollapsed', next ? '1' : '0'); } catch (e) {}
        }

        if (collapseBtn) collapseBtn.addEventListener('click', () => toggleSidebarCollapsed());

        // sidebar clear cache button (bottom of sidebar)
        const sidebarClearBtn = document.getElementById('sidebarClearCache');
        if (sidebarClearBtn) {
            sidebarClearBtn.addEventListener('click', (e) => {
                e.preventDefault();
                clearCache(true);
            });
        }

        // restore saved state
        (function restoreSidebar() {
            try {
                const v = localStorage.getItem('sidebarCollapsed');
                const collapsed = v === '1';
                // only apply collapsed state on wider screens
                if (window.innerWidth > 768 && collapsed) applySidebarState(true);
                else if (toggleBtn) {
                    // ensure mobile toggle visibility when not collapsed
                    toggleBtn.style.display = (window.innerWidth <= 768) ? 'flex' : 'none';
                }
            } catch (e) {}
        })();

        // keep toggle visibility in sync on resize
        window.addEventListener('resize', () => {
            try {
                // if currently in collapsed (mini) mode, hide toggle on wider screens
                if (sidebar.classList.contains('collapsed') && window.innerWidth > 768) {
                    if (toggleBtn) toggleBtn.style.display = 'none';
                } else {
                    if (toggleBtn) toggleBtn.style.display = (window.innerWidth <= 768) ? 'flex' : 'none';
                }
            } catch (e) {}
        });
        // allow keyboard shortcut 'c' to toggle collapse (desktop)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'c' || e.key === 'C') {
                if (window.innerWidth > 768) toggleSidebarCollapsed();
            }
        });

        // ===== INITIALIZATION =====
        loadPhotosFromDB();
        loadTheme();
    </script>
</body>

</html>
